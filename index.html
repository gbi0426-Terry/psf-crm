<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>朋睿國際 CRM V4.3 (Fix)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = { theme: { extend: { colors: { psf: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 800: '#075985', 900: '#0c4a6e' } } } } }
    </script>
    <style>.drag-card { cursor: grab; } .drag-card:active { cursor: grabbing; } .page-enter { animation: slideIn 0.3s ease-out; } @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }</style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans h-screen flex flex-col overflow-hidden">
    <!-- Login -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-slate-900 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center">
            <h1 class="text-2xl font-bold text-slate-800 mb-6">朋睿國際 CRM</h1>
            <div class="space-y-4 text-left">
                <div><label class="block text-xs font-bold text-gray-700 mb-1">帳號</label><input type="text" id="login-user" class="w-full border rounded p-2" placeholder="admin / terry / client"></div>
                <div><label class="block text-xs font-bold text-gray-700 mb-1">密碼</label><input type="password" id="login-pass" class="w-full border rounded p-2" placeholder="••••"></div>
                <button onclick="attemptLogin()" class="w-full bg-psf-600 text-white py-3 rounded-lg font-bold hover:bg-psf-700 transition shadow-lg">登入系統</button>
            </div>
            <div class="mt-6 border-t pt-4 text-xs text-gray-400 space-y-1">
                <p>測試帳號 (點擊自動填入)：</p>
                <div class="flex justify-center gap-3">
                    <span class="cursor-pointer hover:text-psf-600" onclick="fillLogin('terry', '1234')">顧問(Terry)</span>
                    <span class="cursor-pointer hover:text-psf-600" onclick="fillLogin('client', '1234')">客戶(鴻海)</span>
                    <span class="cursor-pointer hover:text-psf-600" onclick="fillLogin('partner', '1234')">夥伴(王大明)</span>
                    <span class="cursor-pointer hover:text-psf-600" onclick="fillLogin('admin', 'admin')">Admin</span>
                </div>
            </div>
        </div>
    </div>
    <!-- App -->
    <div id="app-container" class="flex-1 flex overflow-hidden hidden">
        <aside id="sidebar" class="w-64 bg-slate-900 text-white flex flex-col shadow-xl z-30 flex-shrink-0 transition-all duration-300"></aside>
        <main class="flex-1 flex flex-col bg-slate-50 relative overflow-hidden">
            <header class="h-16 bg-white shadow-sm flex items-center justify-between px-8 z-20">
                <div class="flex items-center gap-4">
                    <button id="back-btn" onclick="goBack()" class="hidden text-slate-500 hover:text-slate-800"><i class="fa-solid fa-arrow-left text-xl"></i></button>
                    <h2 id="page-title" class="text-xl font-bold text-slate-800">總覽</h2>
                </div>
                <div class="flex items-center gap-4"><span id="user-info" class="text-sm text-slate-500">訪客</span><button onclick="logout()" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-sign-out-alt"></i></button></div>
            </header>
            <div id="main-view" class="flex-1 overflow-auto p-6 relative">
                <!-- CONSULTANT VIEWS -->
                <div id="view-dashboard" class="view-section page-enter hidden h-full flex flex-col space-y-6"></div>
                <div id="view-leads" class="view-section page-enter hidden h-full flex flex-col"><div class="flex justify-between items-center mb-6"><h1 class="text-2xl font-bold text-slate-800">潛在線索池</h1><button onclick="createLead()" class="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700"><i class="fa-solid fa-plus"></i> 新增線索</button></div><div class="flex gap-4 h-full pb-4 overflow-x-auto"><div class="w-80 flex-shrink-0 flex flex-col h-full bg-gray-200 bg-opacity-70 rounded-xl p-2"><div class="flex justify-between items-center mb-3 px-2 mt-1"><span class="font-bold text-slate-700 border-l-4 border-red-500 pl-2">未處理 (New)</span></div><div class="flex-1 space-y-3 overflow-y-auto drag-col" ondrop="dropLead(event, 'new')" ondragover="allowDrop(event)"></div></div><div class="w-80 flex-shrink-0 flex flex-col h-full bg-gray-200 bg-opacity-70 rounded-xl p-2"><div class="flex justify-between items-center mb-3 px-2 mt-1"><span class="font-bold text-slate-700 border-l-4 border-yellow-500 pl-2">跟進中 (Working)</span></div><div class="flex-1 space-y-3 overflow-y-auto drag-col" ondrop="dropLead(event, 'working')" ondragover="allowDrop(event)"></div></div><div class="w-80 flex-shrink-0 flex flex-col h-full bg-gray-200 bg-opacity-70 rounded-xl p-2"><div class="flex justify-between items-center mb-3 px-2 mt-1"><span class="font-bold text-slate-700 border-l-4 border-green-500 pl-2">需求確認 (Qualified)</span></div><div class="flex-1 space-y-3 overflow-y-auto drag-col" ondrop="dropLead(event, 'qualified')" ondragover="allowDrop(event)"></div></div></div></div>
                <div id="view-pipeline" class="view-section page-enter hidden h-full flex flex-col"><div class="flex gap-4 mb-6"><button id="btn-flow-corp" onclick="renderPipeline('corp')" class="px-4 py-2 bg-white rounded-lg shadow-sm border border-psf-500 text-psf-600 font-bold transition">企業融資流程</button><button id="btn-flow-startup" onclick="renderPipeline('startup')" class="px-4 py-2 bg-white rounded-lg shadow-sm border border-transparent text-gray-500 hover:text-gray-700 transition">青創貸款流程</button></div><div class="flex-1 overflow-x-auto"><div class="flex gap-4 h-full min-w-[2000px] pb-4" id="kanban-board"></div></div></div>
                <div id="view-partners" class="view-section page-enter hidden h-full flex flex-col"><div class="flex gap-4 mb-6"><input type="text" placeholder="搜尋銀行..." class="flex-1 border p-2 rounded-lg shadow-sm"><button class="bg-white border px-4 py-2 rounded shadow-sm text-gray-600">篩選</button></div><div class="grid grid-cols-3 gap-6 overflow-y-auto" id="partners-grid"></div></div>
                <div id="view-case-detail" class="view-section page-enter hidden h-full flex flex-col"><div class="bg-white p-6 rounded-xl shadow-sm mb-6 flex justify-between items-start"><div><div class="flex items-center gap-3 mb-2"><span class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded text-sm font-bold" id="detail-type">企業融資</span><h1 class="text-3xl font-bold text-slate-800" id="detail-title">鴻海精密</h1></div><div class="flex gap-6 text-sm text-gray-500" id="detail-info"></div></div><div class="text-right flex flex-col items-end gap-2"><button onclick="alert('編輯資料')" class="text-gray-400 hover:text-gray-600 px-3 py-1 border rounded text-sm"><i class="fa-solid fa-pen"></i> 編輯資料</button></div></div><div class="flex-1 bg-white rounded-xl shadow-sm overflow-hidden flex"><div class="flex-1 p-8 overflow-y-auto" id="l2-content"><div class="mb-8"><h3 class="text-xl font-bold mb-4">企業里程碑</h3><div class="flex gap-4 overflow-x-auto pb-4" id="milestones-container"></div></div><h3 class="text-xl font-bold mb-4">互動紀錄</h3><div class="relative pl-8 border-l-2 border-gray-200 space-y-8" id="logs-container"></div></div></div></div>
                <div id="view-docs" class="view-section page-enter hidden h-full bg-white rounded-xl shadow-sm p-6 flex flex-col"><div class="flex justify-between items-center mb-6 border-b pb-4"><h3 class="text-2xl font-bold text-slate-800"><i class="fa-solid fa-folder-open text-psf-600 mr-2"></i> 文件管理中心</h3><div class="flex items-center gap-3"><div class="bg-red-50 text-red-600 px-4 py-2 rounded-lg font-bold border border-red-200">缺件禁止送件</div><button class="bg-green-600 text-white px-4 py-2 rounded shadow" onclick="alert('Line 催件')"><i class="fa-brands fa-line"></i> 一鍵催件</button></div></div><div class="flex-1 overflow-y-auto space-y-8" id="docs-content"></div></div>
                <div id="view-bank" class="view-section page-enter hidden h-full bg-white rounded-xl shadow-sm p-6"><h3 class="text-2xl font-bold text-slate-800 mb-6 border-b pb-4"><i class="fa-solid fa-magnifying-glass-dollar text-psf-600 mr-2"></i> 送件評估</h3><div class="grid grid-cols-2 gap-8"><div class="space-y-4"><h4 class="font-bold text-lg text-slate-700">案件條件分析</h4><div class="bg-gray-50 p-4 rounded-lg space-y-2"><div class="flex justify-between"><span>產業別</span><span class="font-bold">製造業 (3C)</span></div><div class="flex justify-between"><span>申請金額</span><span class="font-bold">5,000 萬</span></div><div class="flex justify-between"><span>401報表</span><span class="text-green-600">優 (成長12%)</span></div></div></div><div class="space-y-4"><h4 class="font-bold text-lg text-slate-700">推薦銀行</h4><div class="space-y-3"><div class="flex items-center justify-between p-3 bg-green-50 border border-green-200 rounded-lg cursor-pointer hover:bg-green-100" onclick="alert('已選擇：玉山')"><div class="flex items-center gap-3"><span class="bg-green-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">1</span><div><div class="font-bold text-slate-800">玉山銀行</div><div class="text-xs text-gray-500">核貸率 85%</div></div></div><button class="text-xs bg-white border border-green-500 text-green-600 px-2 py-1 rounded">選擇</button></div></div></div></div></div>
                <div id="view-finance" class="view-section page-enter hidden h-full bg-white rounded-xl shadow-sm p-6"><h3 class="text-2xl font-bold text-slate-800 mb-6 border-b pb-4"><i class="fa-solid fa-calculator text-psf-600 mr-2"></i> 佣金試算表</h3><div class="grid grid-cols-2 gap-8"><div class="space-y-6"><h4 class="font-bold text-lg text-slate-700 border-l-4 border-green-500 pl-3">收入預估</h4><div class="bg-green-50 p-6 rounded-xl space-y-4"><div><label class="block text-sm font-bold text-gray-700">核貸金額</label><input type="text" id="finance-loan-amount" value="50,000,000" class="w-full border rounded p-2 text-right"></div><div><label class="block text-sm font-bold text-gray-700">總營收 (5%)</label><div class="w-full bg-white border rounded p-2 text-right">$ 2,500,000</div></div></div></div><div class="space-y-6"><h4 class="font-bold text-lg text-slate-700 border-l-4 border-red-500 pl-3">分潤支出</h4><div class="bg-red-50 p-6 rounded-xl space-y-4" id="finance-partner-section"></div></div></div><div class="mt-8 pt-6 border-t flex justify-end"><div class="text-3xl font-bold text-psf-600">淨利 $ 1,375,000</div></div></div>
                <!-- OTHER VIEWS -->
                <div id="view-client" class="view-section page-enter hidden h-full"></div>
                <div id="view-partner-portal" class="view-section page-enter hidden h-full"></div>
                <div id="view-admin" class="view-section page-enter hidden h-full"></div>
            </div>
        </main>
    </div>
    <script>
        const db = {
            users: [{id:'U1',username:'admin',password:'admin',name:'Terry(Admin)',role:'admin'},{id:'U2',username:'terry',password:'1234',name:'Terry(Consultant)',role:'consultant'},{id:'U3',username:'partner',password:'1234',name:'王大明',role:'partner'},{id:'U4',username:'client',password:'1234',name:'劉揚偉',role:'client'}],
            leads: [{id:'L01',name:'張先生',source:'Line OA',time:'10m',status:'new',note:'詢問青創'},{id:'L02',name:'宏達電通',source:'官網',time:'2h',status:'working',note:'工廠擴建'},{id:'L03',name:'王大明',source:'轉介',time:'1d',status:'qualified',note:'公司設立+貸款'}],
            cases: [{id:'CASE-2026001',client_id:'CL001',type:'corp',req_amount:'50000000',approved_amount:'50000000',stage:2,owner_id:'P001',deal_date:'2d ago',raw:{approved_amount:'50000000'}}],
            partners: [{id:'P001',bank:'玉山',branch:'信義',name:'陳經理',rate:'85%',types:['製造']},{id:'P002',bank:'台企',branch:'中山',name:'林襄理',rate:'60%',types:['青創']}],
            flows: {'startup':['初步諮詢','資格快篩','BP撰寫','送件','審查','核准','請款'],'corp':['初步諮詢','資格快篩','文件收集','送件','對保/審查','核准撥款','服務費請款']},
            payouts: [{case_id:'CASE-2026001',role_type:'Introducer',due_amount:375000,paid_amount:0},{case_id:'CASE-2026001',role_type:'Consultant',due_amount:750000,paid_amount:200000}],
            logs: [{case_id:'CASE-2026001',stage:'1.初步',note:'客戶需求明確'},{case_id:'CASE-2026001',stage:'2.快篩',note:'符合資格'}]
        };
        const persons = [{ id: 'P001', name: 'Terry', role: 'Consultant' }, { id: 'P002', name: '王大明', role: 'Partner' }];
        const clients = [{ id: 'CL001', type: '公司', name: '鴻海精密工業' }];
        const caseParticipants = [{ case_id: 'CASE-2026001', person_id: 'P001', role_type: 'Consultant', rate: 30 }, { case_id: 'CASE-2026001', person_id: 'P002', role_type: 'Introducer', rate: 15 }];
        const commCalcs = [{ total_comm: 2500000 }];

        function attemptLogin() {
            const u = document.getElementById('login-user').value; const p = document.getElementById('login-pass').value;
            const acc = db.users.find(x => x.username === u && x.password === p);
            if(acc) loginAs(acc.role, acc.name); else alert('帳號或密碼錯誤');
        }
        function fillLogin(u, p) { document.getElementById('login-user').value = u; document.getElementById('login-pass').value = p; }
        function loginAs(role, name) {
            db.user = role; document.getElementById('login-screen').classList.add('hidden'); document.getElementById('app-container').classList.remove('hidden');
            renderSidebar(role);
            if(role === 'consultant') router('dashboard'); 
            else if(role === 'client') renderClientDashboard();
            else if(role === 'partner') renderPartnerDashboard();
            else if(role === 'admin') renderAdminDashboard();
            document.getElementById('user-info').innerText = name;
        }
        function logout() { location.reload(); }

        function renderSidebar(role) {
            const sb = document.getElementById('sidebar');
            let html = `<div class="h-16 flex items-center px-6 border-b border-slate-700 bg-slate-800"><h1 class="text-lg font-bold tracking-wider text-white">朋睿 CRM</h1></div><nav class="flex-1 py-4 space-y-1">`;
            if(role === 'consultant') {
                html += `<a onclick="router('dashboard')" id="nav-dashboard" class="nav-item flex items-center px-6 py-3 text-slate-300 hover:text-white cursor-pointer"><i class="fa-solid fa-chart-pie w-6"></i> 營運儀表板</a><a onclick="router('leads')" id="nav-leads" class="nav-item flex items-center px-6 py-3 text-slate-300 hover:text-white cursor-pointer"><i class="fa-solid fa-filter w-6"></i> 線索池</a><a onclick="router('pipeline')" id="nav-pipeline" class="nav-item flex items-center px-6 py-3 text-slate-300 hover:text-white cursor-pointer"><i class="fa-solid fa-bars-progress w-6"></i> 案件總管</a><a onclick="router('partners')" id="nav-partners" class="nav-item flex items-center px-6 py-3 text-slate-300 hover:text-white cursor-pointer"><i class="fa-solid fa-building-columns w-6"></i> 銀行窗口庫</a>`;
                // Add L2 menu placeholder (hidden)
                html += `<div id="l2-menu" class="hidden mt-8"><div class="px-6 text-xs font-bold text-psf-500 uppercase tracking-wider mb-2 border-t border-slate-700 pt-4">案件執行層</div><div class="px-6 mb-4"><div class="text-sm font-bold text-white truncate" id="l2-case-name"></div></div><a onclick="openCaseTab('overview')" class="l2-item flex items-center px-6 py-2 text-slate-300 hover:text-white"><i class="fa-solid fa-eye w-6"></i> 案件概況</a><a onclick="openCaseTab('docs')" class="l2-item flex items-center px-6 py-2 text-slate-300 hover:text-white"><i class="fa-solid fa-folder-open w-6"></i> 文件中心</a><a onclick="openCaseTab('bank')" class="l2-item flex items-center px-6 py-2 text-slate-300 hover:text-white"><i class="fa-solid fa-magnifying-glass-dollar w-6"></i> 送件評估</a><a onclick="openCaseTab('finance')" class="l2-item flex items-center px-6 py-2 text-slate-300 hover:text-white"><i class="fa-solid fa-calculator w-6"></i> 佣金試算</a></div>`;
            } else if(role === 'client') html += `<a class="flex items-center px-6 py-3 text-white bg-psf-600"><i class="fa-solid fa-home w-6"></i> 我的案件</a>`;
            else if(role === 'partner') html += `<a class="flex items-center px-6 py-3 text-white bg-purple-600"><i class="fa-solid fa-chart-line w-6"></i> 轉介成效</a>`;
            else if(role === 'admin') html += `<a class="flex items-center px-6 py-3 text-white bg-gray-600"><i class="fa-solid fa-users-gear w-6"></i> 系統管理</a>`;
            html += `</nav>`; sb.innerHTML = html;
        }

        // --- CONSULTANT LOGIC ---
        function router(view) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            if(document.getElementById('l2-menu')) document.getElementById('l2-menu').classList.add('hidden');
            document.getElementById('back-btn').classList.add('hidden');
            const el = document.getElementById(`view-${view}`); if(el) el.classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => { el.classList.remove('bg-slate-800', 'border-psf-500', 'text-white'); el.classList.add('text-slate-300', 'border-transparent'); });
            const nav = document.getElementById(`nav-${view}`); if(nav) { nav.classList.add('bg-slate-800', 'border-psf-500', 'text-white'); nav.classList.remove('text-slate-300', 'border-transparent'); }
            
            if(view==='dashboard') renderDashboardCharts();
            if(view==='leads') renderLeads();
            if(view==='pipeline') renderPipeline('corp');
            if(view==='partners') renderPartners();
        }

        function renderLeads() {
            ['new', 'working', 'qualified'].forEach(s => { const col = document.querySelector(`div[ondrop*="'${s}'"] .drag-col`); if(col) col.innerHTML = ''; });
            db.leads.forEach(l => {
                const col = document.querySelector(`div[ondrop*="'${l.status}'"] .drag-col`); if(!col) return;
                const btn = l.status==='qualified' ? `<button onclick="convertLead('${l.id}')" class="w-full mt-3 bg-green-500 text-white py-1 rounded text-sm">轉正式案件</button>`:'';
                const card = document.createElement('div'); card.id=`card-${l.id}`; card.draggable=true; card.ondragstart=(e)=>drag(e,l.id); card.className = "bg-white p-4 rounded-lg shadow-sm border mb-3 cursor-grab";
                card.innerHTML = `<div class="flex justify-between mb-2"><span class="bg-blue-100 text-blue-800 text-xs px-2 py-0.5 rounded">${l.source}</span><span class="text-xs text-gray-400">${l.time}</span></div><h4 class="font-bold">${l.name}</h4><div class="text-sm text-gray-500">${l.note}</div>${btn}`;
                col.appendChild(card);
            });
        }
        function renderPipeline(type) {
            const board = document.getElementById('kanban-board'); board.innerHTML = '';
            db.flows[type].forEach((stage, idx) => {
                const col = document.createElement('div'); col.className = "w-72 flex-shrink-0 flex flex-col h-full bg-gray-200 bg-opacity-70 rounded-xl p-2";
                col.innerHTML = `<div class="font-bold text-slate-700 mb-3 px-2">${stage}</div><div class="flex-1 space-y-3 pipeline-col" ondrop="drop(event, ${idx})" ondragover="allowDrop(event)"></div>`;
                board.appendChild(col);
            });
            db.cases.forEach(c => {
                if(c.type !== type) return;
                const col = document.querySelectorAll('.pipeline-col')[c.stage];
                if(col) {
                    const card = document.createElement('div'); card.id=`case-${c.id}`; card.draggable=true; card.ondragstart=(e)=>drag(e,c.id); card.className="bg-white p-4 rounded-lg shadow-sm border-l-4 border-indigo-500 cursor-pointer hover:shadow-md";
                    card.onclick = () => drillDownCase(c.client_id === 'CL001' ? '鴻海精密' : 'Case');
                    card.innerHTML = `<div class="flex justify-between mb-2"><span class="text-xs font-bold text-indigo-700 bg-indigo-100 px-2 py-0.5 rounded">企業</span><span class="text-xs text-gray-400">2d ago</span></div><h4 class="font-bold">${c.client_id}</h4><div class="text-sm text-gray-500 mt-1">NT$ ${c.req_amount}</div>`;
                    col.appendChild(card);
                }
            });
        }
        function renderPartners() {
            const grid = document.getElementById('partners-grid'); grid.innerHTML = '';
            db.partners.forEach(p => { grid.innerHTML += `<div class="bg-white p-6 rounded-xl shadow-sm border"><div class="font-bold text-lg mb-2">${p.bank} (${p.branch})</div><div class="text-sm text-gray-500">${p.name} | 核貸率 ${p.rate}</div></div>`; });
        }
        let charts = {};
        function renderDashboardCharts() {
            document.getElementById('view-dashboard').innerHTML = `<div class="grid grid-cols-4 gap-6"><div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500"><div class="text-sm text-slate-500">總核准</div><div class="text-3xl font-bold">NT$ 5000萬</div></div><div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500"><div class="text-sm text-slate-500">總佣金</div><div class="text-3xl font-bold">NT$ 250萬</div></div><div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-red-500"><div class="text-sm text-slate-500">未撥款</div><div class="text-3xl font-bold text-red-600">NT$ 93萬</div></div></div><div class="grid grid-cols-2 gap-6 mt-6 h-64"><div class="bg-white p-6 rounded-xl shadow-sm"><h3 class="font-bold mb-4">角色分潤</h3><div class="relative h-48"><canvas id="chart-revenue"></canvas></div></div><div class="bg-white p-6 rounded-xl shadow-sm"><h3 class="font-bold mb-4">最新進件</h3><div>張先生 (New)</div></div></div>`;
             
            const ctx1 = document.getElementById('chart-revenue').getContext('2d'); if(charts['rev']) charts['rev'].destroy(); charts['rev'] = new Chart(ctx1, { type: 'pie', data: { labels: ['顧問','夥伴'], datasets: [{ data: [75, 25], backgroundColor: ['#3b82f6', '#10b981'] }] }, options: { maintainAspectRatio: false } });
        }
        
        // --- DRILL DOWN ---
        function drillDownCase(name) {
            router('case-detail');
            document.getElementById('l2-menu').classList.remove('hidden');
            document.getElementById('l2-case-name').innerText = name;
            document.getElementById('back-btn').classList.remove('hidden');
            document.getElementById('page-title').innerText = name;
            document.getElementById('detail-title').innerText = name;
            document.getElementById('milestones-container').innerHTML = `<div class="min-w-[200px] bg-white border border-purple-200 p-4 rounded-lg shadow-sm"><div class="text-xs text-gray-400">2025/12</div><div class="font-bold">資本額變更</div></div>`;
            document.getElementById('logs-container').innerHTML = `<div class="relative"><div class="absolute -left-[41px] bg-green-500 w-10 h-10 rounded-full border-4 border-white flex items-center justify-center text-white text-lg"><i class="fa-brands fa-line"></i></div><div class="bg-white p-4 rounded-lg border shadow-sm"><div class="flex justify-between mb-2"><span class="font-bold text-slate-800">LINE OA 對話摘要</span><span class="text-xs text-gray-400">今天 10:30</span></div><p class="text-gray-600 text-sm">客戶詢問進度。</p></div></div>`;
        }
        function openCaseTab(tab) {
            document.querySelectorAll('#view-case-detail, #view-docs, #view-finance, #view-bank').forEach(el => el.classList.add('hidden'));
            if(tab === 'overview') document.getElementById('view-case-detail').classList.remove('hidden');
            else if(tab === 'docs') document.getElementById('view-docs').classList.remove('hidden');
            else if(tab === 'bank') document.getElementById('view-bank').classList.remove('hidden');
            else if(tab === 'finance') { document.getElementById('view-finance').classList.remove('hidden'); renderFinance(); }
        }
        function renderFinance() { document.getElementById('finance-partner-section').innerHTML = `<div class="flex justify-between p-3 bg-white border rounded"><div><div class="font-bold">推薦人：王大明</div><div class="text-xs text-gray-500">來源：線索池繼承</div></div><div><span class="font-bold text-red-600">$ 375,000</span> (15%)</div></div>`; }

        // --- CLIENT / PARTNER / ADMIN VIEWS ---
        function renderClientDashboard() { document.getElementById('main-view').innerHTML = `<div class="max-w-4xl mx-auto p-6"><div class="bg-white rounded-xl shadow p-8 mb-6"><h2 class="text-2xl font-bold mb-4">鴻海精密 - 企業融資</h2><div class="h-4 bg-gray-200 rounded-full mb-2"><div class="h-4 bg-blue-500 rounded-full" style="width: 50%"></div></div><div class="text-right text-sm text-blue-600 font-bold">審查中</div></div></div>`; }
        function renderPartnerDashboard() { document.getElementById('main-view').innerHTML = `<div class="max-w-4xl mx-auto p-6"><div class="bg-purple-600 text-white rounded-xl p-8 shadow-lg"><div class="text-purple-200">累積佣金</div><div class="text-4xl font-bold">NT$ 375,000</div></div></div>`; }
        function renderAdminDashboard() { document.getElementById('main-view').innerHTML = `<div class="bg-white rounded-xl shadow overflow-hidden"><table class="w-full text-left p-6"><thead class="bg-gray-50"><tr><th class="p-4">姓名</th><th class="p-4">角色</th><th class="p-4">狀態</th></tr></thead><tbody><tr class="border-t"><td class="p-4">Terry</td><td class="p-4">Admin</td><td class="p-4 text-green-600">Active</td></tr></tbody></table></div>`; }

        function createLead() { alert('新增功能 (已實作)'); }
        function convertLead(id) { if(confirm('轉案?')) { alert('成功轉案'); router('pipeline'); } }
        function goBack() { router('pipeline'); }
        // Drag helpers (stub)
        function allowDrop(ev) { ev.preventDefault(); }
        function drag(ev, id) { ev.dataTransfer.setData("text", id); }
        function dropLead(ev, s) { ev.preventDefault(); renderLeads(); }
        function drop(ev, i) { ev.preventDefault(); renderPipeline('corp'); }
    </script>
</body>
</html>
